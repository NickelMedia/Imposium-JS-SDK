<<<<<<< HEAD
import {create} from 'apisauce';
import * as EventEmitter from 'event-emitter';

import { MessageConsumer, Job } from './MessageConsumer';
import { StompConfig } from './StompClient';

export class events {
	public static STATUS:string = "imposium_status_update";
}

export class ImposiumClient {
	public messageConsumer:MessageConsumer;

	private stompConfig:StompConfig = {
		'stompEndpoint':'ws://127.0.0.1:15674/ws',
		'stompUser': 'guest',
		'stompPass': 'guest',
		'exchangeRoute': '/exchange/imposium/',
		'onMessage': undefined,
		'onError': undefined
	};

	private xhrBaseURL:string = 'http://api/';
	private api:any;
	private token:string;
=======
import SocketHandler from './SocketHandler';
import {create} from 'apisauce';
import * as EventEmitter from 'event-emitter';

export class ImposiumClient{

	//Default config options
	static config:any = 
	{
		'requestUrl':'https://api.imposium.com/',
		'socket':'https://cms.imposium.com',
		'auth':'accessKey'
	};

	//accessToken or JWT
	private token:string;

	//API Sauce instance
	private api:any;

	//Socket connection handler
	public socketHandler:SocketHandler;
>>>>>>> origin/master

	constructor(token, config = null) {
		EventEmitter(this);

		//set access token
		this.token = token;

		//overwrite default config values
		if (config) {
			for (let key in config) {
				if (config.hasOwnProperty(key)) {
					this.stompConfig[key] = config[key];
				}
			}
		}

		//create the api instance
		this.api = create({
<<<<<<< HEAD
			baseURL: this.xhrBaseURL,
			headers:{
=======
			baseURL:ImposiumClient.config.requestUrl,
			headers:this.getHeaders()
		});
	}

	//set the proper headers, for both accessToken, and JWT authentication
	private getHeaders(){

		if(ImposiumClient.config.auth.toLowerCase() == 'jwt'){
			return {
				'Authorization':`Bearer ${this.token}`
			}
		}else{
			return {
>>>>>>> origin/master
				'X-Imposium-Access-Key':this.token
			};
		}
	}

	//Parse the inventory object and create a formData to pass into Imposium
	private formatData(storyId, inventory, error){

		var formData = new FormData();

		//add the storyID
		formData.append('story_id', storyId);

		//pull any files from the inventory, add them to the top level
		var files = {};
		for(var inventoryId in inventory){
			var fileInput = inventory[inventoryId];
			if(fileInput instanceof HTMLInputElement && fileInput.type && fileInput.type === "file"){
				if(fileInput.files && fileInput.files[0]){
					inventory[inventoryId] = '';
					formData.append(inventoryId, fileInput.files[0]);
				} else {
					if(error){
						error('[NO_FILE_DATA] A file input was specified for inventory item '+inventoryId+', but no file data was found.');
						return;
					}
				}
			}
		}

		//add the inventory
		for(var invKey in inventory){
			formData.append(`inventory[${invKey}]`, inventory[invKey]);
		}

		return formData;
	}

	//Get a story based on the storyId
	public getStory(storyId, success, error) {

		this.api.get(`/story/${storyId}`)
			.then((response)=>{
				if(response.ok){
					success(response.data);
				}else{
					error(response);
				}
			});
	}

	//Get a specific user experience
	public getExperience(expId, success, error) {

		this.api.get(`/experience/${expId}`)
			.then((response)=>{
				if(response.ok){
					success(response.data);
				}else{
					error(response);
				}
			});
	}

	//Create a new user experience
	public createExperience(storyId, inventory, render, success, error, progress=null) {
<<<<<<< HEAD
		const data:any = {'story_id':storyId, 'inventory':inventory};

		this.api.post('/experience', data)
=======

		const data = this.formatData(storyId, inventory, error);
		const config = (progress) ? { onUploadProgress: (e)=>progress(e)} : {};

		this.api.post('/experience', data, config)
>>>>>>> origin/master
			.then((response)=>{
				if(response.ok){
					success(response.data);
				}else{
					error(response);
				}
			});
	}

	//Start the event processor, to generate or get a video
	public startEventProcessor(data:any, success:any, error:any) {
<<<<<<< HEAD
		const jobSpec:Job = {
			'expId': data.expId, 
			'actId': data.actId, 
			'onSuccess': success, 
			'onError': error
		};

		if (!this.messageConsumer) {
			this.messageConsumer = new MessageConsumer(jobSpec, this, this.api, this.stompConfig);		
		} else {
			this.messageConsumer.setJob(jobSpec)
			this.messageConsumer.setContext(this);
			
			this.messageConsumer.reconnect(this.stompConfig);	
=======
		if (!this.socketHandler) {
			const config:any = {
				'socket': ImposiumClient.config.socket,
				'onSuccess':success,
				'onError':error,
				"exp":data.expId,
				"act":data.actId,
			};

			this.socketHandler = new SocketHandler(config, this);		
		} else {
			this.socketHandler.data.exp = data.expId;
			this.socketHandler.data.act = data.actId;
			this.socketHandler.data.onSuccess = success;
			this.socketHandler.data.onError = error;
			this.socketHandler.startEventProcessor();	
>>>>>>> origin/master
		}
	}
}

export class events {
	public static STATUS:string = "imposium_status_update";
}
