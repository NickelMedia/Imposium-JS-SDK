<html>
    
    <head>
        <title>Imposium Basic Example</title>
        <link rel="stylesheet" type="text/css" href="css/styles.css">
    </head>

    <body>
        
        <div>

            <h2>Enter a caption, upload an image, and hit Generate Video</h2>

            <label for = "caption">Caption</label>
            <input id = "caption" name = "caption" type = "text" placeholder = "Caption"/>
            <br/>

            <label for = "image">Image</label>
            <input id = "image" name = "image" type = "file"/>
            <br/>
            <br/>

            <button id = "btnGenerate">Generate Video</button>
            <br/>
            <br/>

            <span id = "status"></span>
            <br/>

            <video id = "dynamicVideo" controls autoplay></video>
        </div>
        
        <script type = "text/javascript" src = "../lib/imposium.js"></script>
        
        <script type = "text/javascript">
            var statusField = document.getElementById('status'),
                captionInput = document.getElementById('caption'),
                imageInput = document.getElementById('image'),
                vid = document.getElementById('dynamicVideo'),
                btnGenerate = document.getElementById('btnGenerate'),
                statusHandler = onStatusUpdate;

            // Variables required to interact with the Imposium client
            // storyId - Imposium storyId (relates to an experience template)
            // actId - What particular act the job is related to
            // accessKey - access key for public endpoints
            var storyId = "819868af-daeb-408a-eb16-0f8f8a462d96",
                actId = "cd24347a-bc1d-4d75-cae7-a287872b10fa",
                token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik0wTkZNek13TlRRM1JEaEZOMEUwT1RORk4wSTFNREE0TTBZeE1FWTVSVGxET0RBd1JUaEdPQSJ9.eyJodHRwczovL2ltcG9zaXVtLmNvbS9yb2xlcyI6eyJpbXBvc2l1bSI6ImFkbWluIiwidmlkZW9fYnVpbGRlciI6Im5vbmUiLCJmb290YWdlX2FwcCI6Im5vbmUiLCJhZF91cGxvYWRlciI6Im5vbmUifSwiaXNzIjoiaHR0cHM6Ly9pbXBvc2l1bS5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NTkzZWUwZDBhMzYwMmY0MGViNzhlZTlmIiwiYXVkIjoiMm1tZWVhejNUZ3VsMEQ3ME84MjdSVldKTWtrbzNDQmoiLCJpYXQiOjE1MDkxMTc5MDAsImV4cCI6MTUwOTIwNDMwMH0.D15IJ4G0BTj9Ydy7tYWUeUcXeRzIfx7WfqLuLufIR5AjLwDTe0b18U-1A471i_MMYGyfHPyjuwbLR6itfiCi_gbsliLaT5zboDCZSdnC67ptAaV--7-4E9FknFYDnoyg3OxrLusJBJae1NkDEjsnSj_9toAB9BxYg4fayNGtJ0YzgVB7kIZPcfIpXxhlcljtME2siraNgro267RS1zOqApwKPpLhET-4GDzUZF_yksUvblpD-psbIzAFlgubDDzaiQ8_J0tKZ7HKkSOgCndZ6_1b-T5IpqCDfi5ccuYzK-cKhJEhgXkddiqTcT-SgfUWI5NVL7O-VDexeEXVhKDxxw';

            var config = {auth: 'JWT'};

            // Create an instance of the ImposiumClient
            var imposium = new Imposium.ImposiumClient(token, config);

            // If there is a deeplink to an experience, connect to that experience
            if (window.location.hash !== "") {
                var expId = window.location.hash.replace("#", "");

                if (expId) {
                    var job = {expId: expId, actId: actId};

                    imposium.getVideo(
                        job, 
                        onGotScene, 
                        onEventProcessorError
                    );
                }                   
            }

            // Bind the click event to the generate button
            btnGenerate.addEventListener('click', createExperience);

            /**
             * Creates an experience on Imposium, passing in the caption and/or image 
             */
            function createExperience() {
                // here you can specify a callback URL to hit once the video has rendered
                var inventory = {
                    'text':captionInput.value,
                    'image':imageInput,
                    'callback_url':''
                };
                
                imposium.createExperience(
                    storyId, 
                    inventory,
                    false,
                    onExperienceCreated, 
                    onExperienceError, 
                    onUploadProgress
                );

                setStatus('Creating Experience', 'green');
            }

            /**
             * Callback once all media is uploaded and the experience has been created
             * @param  {obj} data request body containing the experienceId for a job
             */
            function onExperienceCreated(data) {
                var job = {
                    expId: data.id,
                    actId: actId
                }    

                // put the experience in the URL for deeplinking
                window.location.hash = '#' + job.expId;

                imposium.on(
                    Imposium.events.STATUS, 
                    statusHandler, 
                    this
                );

                imposium.getVideo(
                    job,
                    onGotScene,
                    onEventProcessorError
                );
            }

            /**
             * Called once the experience has rendered and is ready to view
             * @param  {obj} data message payload containing the finished job details
             */
            function onGotScene(data) {
                imposium.off(Imposium.events.STATUS, statusHandler, this);

                vid.src = data.mp4Url;
                vid.style.display = 'block';

                setStatus('Got Scene', 'green');
            }

            /**
             * Called through each step of the rendering process
             * @param  {obj} data contains data parsed from request or message payloads
             */
            function onStatusUpdate(data) {
                setStatus(data.msg);
            }

            /**
             * Helper that updates statusField div with incoming messages
             */
            function setStatus(status, color) {
                this.statusField.innerHTML = status;
                this.statusField.style.color = color;
            }

            /**
             * Callback passed to createExperience for monitoring file upload
             * @param  {obj} e object containing request details
             */
            function onUploadProgress(e) {

            }

            /**
             * Callback passed to getVideo for handling api error data
             * @param  {obj} e request error object
             */
            function onExperienceError(e) {
                console.error("Error creating new experience: ", e);
                setStatus('Something went wrong creating the experience, please try again.', 'red');
            }

            /**
             * Callback passed to getVideo for handling render error data
             * @param  {Error} e render related error data
             */
            function onEventProcessorError(e) {
                console.error("Error starting the event procesor: ", e);
                setStatus('Something went wrong while rendering your experience, please try again.', 'red');
            }

        </script>
    </body>
</html>